# Step-3: CQ Validation

## 개요

LlamaIndex Text2Cypher를 사용하여 IP/특허 담당자 페르소나 기반 100개 테스트 케이스로 검증한다.

## Sub-step

| Sub-step | 내용 | 상태 |
|----------|------|------|
| 3-1 | LlamaIndex Text2Cypher 연동 | ✅ 완료 |
| 3-2 | 100개 테스트 케이스 검증 | ✅ 완료 (100%) |

## 기술 스택

| 구성 요소 | 선택 |
|-----------|------|
| Framework | LlamaIndex |
| LLM Provider | OpenRouter |
| LLM Model | Gemini 2.0 Flash |
| Retriever | TextToCypherRetriever |

## 검증 결과 (v8.0 - 버그 수정 완료)

| 지표 | 결과 |
|------|------|
| 성공 (PASS) | 100개 (100%) |
| 데이터 없음 (NO_DATA) | 0개 (0%) |
| 실패 (FAIL) | 0개 (0%) |
| **쿼리 성공률** | **100%** |

**버그 수정 상세**: [logs/phase-3/cq_bugfix_report.md](../../logs/phase-3/cq_bugfix_report.md)

## CQ 카테고리별 결과 (v8.0)

| 카테고리 | 쿼리 수 | 성공 | 성공률 |
|----------|---------|------|--------|
| 기술_진화 | 15 | 15 | 100% |
| 회사_기여 | 15 | 15 | 100% |
| 스펙_영향 | 15 | 15 | 100% |
| 미결_이슈 | 10 | 10 | 100% |
| 회의_결정 | 15 | 15 | 100% |
| 기술_비교 | 10 | 10 | 100% |
| 복합_검색 | 20 | 20 | 100% |
| **총계** | **100** | **100** | **100%** |

## 테스트 데이터셋 v8.0 설계 원칙

### 페르소나: 3GPP RAN1 회의를 모니터링하는 IP/특허 담당자

### 질문 설계 원칙
1. **기술 키워드 중심 검색** - MIMO, NTN, positioning 등
2. **특정 기고서(Tdoc) 추적** - R1-XXXXXXX 형식
3. **스펙 변경사항 파악** - 38.211, 36.213 등
4. **미결 이슈(FFS/TBD) 확인**
5. **내부 ID 사용 금지** - 자연어만 사용

### 질문 유형 예시

| 유형 | 예시 질문 |
|------|----------|
| 기술검색 | "MIMO 관련해서 최근 합의된 내용 보여줘" |
| 미결이슈 | "아직 FFS로 남아있는 이슈들 뭐가 있어?" |
| 기고서추적 | "R1-2001347 문서가 반영된 결정 내용 알려줘" |
| 스펙변경 | "38.211 스펙 수정하는 CR 관련 합의 있어?" |
| 회의별 | "RAN1#120 회의에서 결정된 주요 사항들 보여줘" |

## 버그 수정 내역 (v8.0)

### 수정된 버그 유형

| 버그 유형 | 수정 전 | 수정 후 | 발생 횟수 |
|-----------|---------|---------|-----------|
| 관계명 오류 | `MADEAT` | `MADE_AT` | 78개 |
| 관계명 오류 | `SUBMITTEDBY` | `SUBMITTED_BY` | 25개 |
| 관계명 오류 | `PRESENTEDAT` | `PRESENTED_AT` | 4개 |
| 속성명 오류 | `c.uri` | `c.id` | 25개 |
| 속성명 오류 | `t.tdocId` | `t.tdocNumber` | 16개 |
| 속성명 오류 | `t.decision` | `t.status` | 1개 |
| 경로 오류 | `Agreement→Meeting→Tdoc` | `Agreement→Tdoc, Agreement→Meeting` | 3개 |

### 근본 원인

1. **Spec은 문제 없음** - OWL/RDF 표준 camelCase 네이밍 사용
2. **구현 버그** - JSON-LD 키 참조 오류, Meeting ID 형식 불일치
3. **CQ 쿼리 버그** - Neo4j 관례 미준수, 속성명 오타, 관계 경로 오해

### 교훈

- Neo4j 관계명은 UPPER_SNAKE_CASE 사용 (Spec의 camelCase와 별개)
- JSON-LD의 데이터 속성(`tdoc:`)과 관계 속성(접두사 없음) 구분 필요
- CQ 쿼리 작성 시 실제 DB 스키마와 일치 여부 검증 필수

## 스크립트

| 스크립트 | 용도 |
|----------|------|
| `scripts/phase-3/validation/04_validate_cq_llamaindex.py` | LlamaIndex 기반 CQ 검증 |

## 로그 파일

| 파일 | 설명 |
|------|------|
| `logs/phase-3/cq_test_dataset.json` | 테스트 데이터셋 v8.0 (100개 CQ, 버그 수정 완료) |
| `logs/phase-3/cq_llamaindex_results.json` | LlamaIndex 검증 결과 |
| `logs/phase-3/cq_bugfix_report.md` | 버그 수정 상세 보고서 |

## 검증 도구 (v8.0)

### 버그 수정 스크립트

| 스크립트 | 용도 |
|----------|------|
| `scripts/phase-3/validation/fix_relationship_names.py` | 관계명 버그 일괄 수정 |
| `scripts/phase-3/validation/fix_cq_properties.py` | 속성명 버그 일괄 수정 |

### 질문 카테고리 (v8.0)
1. **기술_진화** (15개) - 기술 표준화 과정 추적
2. **회사_기여** (15개) - 특허 관련 기여자 식별
3. **스펙_영향** (15개) - 스펙 변경 영향도 분석
4. **미결_이슈** (10개) - FFS/TBD 이슈 추적
5. **회의_결정** (15개) - 특정 회의 의사결정 조회
6. **기술_비교** (10개) - 기술 발전 시계열 비교
7. **복합_검색** (20개) - 다중 조건 복합 쿼리

## 변경 이력

| 날짜 | 변경 내용 |
|------|----------|
| 2026-01-22 | 초기 검증 (55% - 스키마 충돌) |
| 2026-01-22 | 스키마 충돌 해결 후 재검증 (99% - 잘못된 DB 포트) |
| 2026-01-22 | CQ 설계 개선 사항 문서화 |
| 2026-01-23 | DB 포트 불일치 수정 (7688→7687), 검증 로직 개선 (NO_DATA 상태 추가) |
| 2026-01-23 | 재검증: PASS 70%, NO_DATA 29%, FAIL 1% (쿼리 성공률 99%) |
| 2026-01-23 | **테스트 데이터셋 v3.0 - IP/특허 담당자 페르소나 기반 재설계** |
| 2026-01-23 | **검증: PASS 67%, NO_DATA 33%, FAIL 0% (쿼리 성공률 100%)** |
| 2026-01-26 | **테스트 데이터셋 v4.0~v7.0 - 7개 카테고리 CQ 100개 재설계** |
| 2026-01-27 | **테스트 데이터셋 v8.0 - 버그 수정 완료, 100% 성공 달성** |
